app-id: io.github.varietywalls.variety
#runtime: org.freedesktop.Platform
#runtime-version: '24.08'
#sdk: org.freedesktop.Sdk
# GNOME is needed to be able to install python-dbus
runtime: org.gnome.Platform
runtime-version: '47'
sdk: org.gnome.Sdk
command: variety
finish-args:
  - --device=dri
  - --share=network
  - --socket=fallback-x11
  - --socket=wayland
  - --own-name=com.peterlevi.Variety
  - --filesystem=~/.config/variety
  - --filesystem=~/.config/variety-profiles
  # Read images to display as wallpapers
  - --filesystem=xdg-pictures:ro
  - --filesystem=~/Pictures:ro
  # FIXME: Disabled because the desktop files created don't know that it's a Flatpak app.
  # Register Variety to start on login
  #- --filesystem=~/.config/autostart
  # Create a desktop file for Variety
  #- --filesystem=~/.local/share/applications
  # Read the current LXQt wallpaper
  - --filesystem=~/.config/pcmanfm-qt/lxqt/settings.conf:ro
  # Read the current KDE 5 wallpaper
  - --filesystem=~/.config/plasma-org.kde.plasma.desktop-appletsrc:ro
modules:
  - build-requirements.json
  - non-isolated-build-requirements.json
  - requirements.json
  - non-isolated-requirements.json

  # Needed by the setup script.
  - name: intltool
    buildsystem: simple
    build-commands:
      - ./configure --prefix /app
      - make install
    sources:
      - type: archive
        url: https://launchpad.net/intltool/trunk/0.51.0/+download/intltool-0.51.0.tar.gz
        sha256: 67c74d94196b153b774ab9f89b2fa6c6ba79352407037c8c14d5aeb334e959cd

  - name: exiv2
    buildsystem: cmake-ninja
    config-opts:
      # - -DEXIV2_ENABLE_BMFF=ON
      - -DEXIV2_ENABLE_INIH=OFF
    builddir: true  
    sources:
      - type: archive
        url:  https://github.com/Exiv2/exiv2/archive/refs/tags/v0.28.1.tar.gz
        sha256: 3078651f995cb6313b1041f07f4dd1bf0e9e4d394d6e2adc6e92ad0b621291fa

  - name: gexiv2
    buildsystem: meson
    build-options:
      env:
        - -PKG_CONFIG_GOBJECT_INTROSPECTION_1_0_GIRDIR=/app/share/gir-1.0
        - -PKG_CONFIG_GOBJECT_INTROSPECTION_1_0_TYPELIBDIR=/app/lib/girepository-1.0
    sources:
      - type: archive
        url:  https://download.gnome.org/sources/gexiv2/0.14/gexiv2-0.14.2.tar.xz
        sha256: 2a0c9cf48fbe8b3435008866ffd40b8eddb0667d2212b42396fdf688e93ce0be

  # Optional runtime dependency
  - name: ImageMagick
    buildsystem: simple
    build-commands:
      - ./configure --prefix /app
      - make install
    sources:
      - type: archive
        url: https://imagemagick.org/archive/ImageMagick-7.1.1-39.tar.xz
        sha256: b5a18ed9eb0db1e5e1fde26fc95f38bd7d71d9de05dde8b23c238debe332fada

  # Build dependency for Feh
  - name: Imlib2
    buildsystem: simple
    build-commands:
      - ./configure --prefix /app
      - make install
    sources:
      - type: archive
        url: https://kumisystems.dl.sourceforge.net/project/enlightenment/imlib2-src/1.12.3/imlib2-1.12.3.tar.xz?viasf=1
        sha256: 96244656576a3e0a6f58b78e514ddc919622ac6806711bc231837eee62c1de34

  # Optional runtime dependency
  # Nitrogen is an alternative but needs GTK 2, which is harder to supply.
  - name: Feh
    buildsystem: simple
    build-commands:
      - cd man
      - PREFIX=/app make all
      - PREFIX=/app make install
    sources:
      - type: archive
        url: https://feh.finalrewind.org/feh-3.10.3.tar.bz2
        sha256: 5426e2799770217af1e01c2e8c182d9ca8687d84613321d8ab4a66fe4041e9c8

  # Build dependency for libayatana-indicator
  - name: libayatana-ido
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://github.com/AyatanaIndicators/ayatana-ido/archive/refs/tags/0.10.4.tar.gz
        sha256: bd59abd5f1314e411d0d55ce3643e91cef633271f58126be529de5fb71c5ab38
    

  # Optional runtime dependency
  - name: libayatana-indicator
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://github.com/AyatanaIndicators/libayatana-indicator/archive/refs/tags/0.9.4.tar.gz
        sha256: a18d3c682e29afd77db24366f8475b26bda22b0e16ff569a2ec71cd6eb4eac95

  # libavif-gdk-pixbuf is already included in org.gnome.Platform//47 and org.freedesktop.Platform//24.08

  - name: Variety
    buildsystem: simple
    build-commands:
      # variety.py is apparently needed by the setup script.
      - cp bin/variety bin/variety.py
      - python3 setup.py install --prefix /app
      # Remove variety.py again to avoid startup failure.
      - rm /app/bin/variety.py
    sources:
      - type: dir
        path: ..
        skip:
          - flatpak-resources
          - flatpak-pip-generator