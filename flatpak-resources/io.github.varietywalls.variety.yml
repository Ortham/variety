# TODO: Should the app ID be com.peterlevi.Variety?
app-id: io.github.varietywalls.variety
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  # Dependency for gexiv2 and libayatana
  - org.freedesktop.Sdk.Extension.vala
command: variety
finish-args:
  - --device=dri
  - --share=network
  - --socket=fallback-x11
  - --socket=wayland
  - --own-name=com.peterlevi.Variety
  # Needed to display app indicator.
  - --talk-name=org.kde.StatusNotifierWatcher
  # Needed for notifications to work.
  - --talk-name=org.freedesktop.Notifications
  # Store files on the host so that the system can access downloaded wallpapers.
  - --filesystem=xdg-config/variety
  - --filesystem=xdg-config/variety-profiles
  # Read images to display as wallpapers
  - --filesystem=xdg-pictures:ro
  # Read wallpapers from /usr/share/backgrounds
  - --filesystem=host-os:ro
  # FIXME: Disabled because the desktop files created don't know that it's a Flatpak app.
  # Register Variety to start on login
  - --filesystem=~/.config/autostart
  # Create a desktop file for Variety
  # Probably best to leave this to Flatpak itself.
  #- --filesystem=~/.local/share/applications
  # Read the current LXQt wallpaper
  - --filesystem=xdg-config/pcmanfm-qt/lxqt/settings.conf:ro
  # Read the current KDE 5 wallpaper
  - --filesystem=xdg-config/plasma-org.kde.plasma.desktop-appletsrc:ro
  # Allow wallpaper to be read and written using gsettings
  - --filesystem=xdg-run/dconf
  - --filesystem=~/.config/dconf:ro
  - --talk-name=ca.desrt.dconf
  - --env=DCONF_USER_CONFIG_DIR=.config/dconf
  - --env=GIO_EXTRA_MODULES=/app/lib/gio/modules/
cleanup:
# TODO: Figure out what's needed at runtime, remove everything else.
modules:
  - build-requirements.json
  - non-isolated-build-requirements.json
  - requirements.json

  # dbus-run-session is needed to build dbus-python
  # It's provided by org.gnome.Sdk//47
  - name: dbus
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DDBUS_BUILD_TESTS=OFF
      - -DENABLE_TRADITIONAL_ACTIVATION=OFF
      - -DENABLE_SYSTEMD=OFF
      - -DDBUS_BUS_ENABLE_INOTIFY=OFF
      - -DDBUS_ENABLE_DOXYGEN_DOCS=OFF
    sources:
      - type: archive
        url: https://dbus.freedesktop.org/releases/dbus/dbus-1.14.10.tar.xz
        sha256: ba1f21d2bd9d339da2d4aa8780c09df32fea87998b73da24f49ab9df1e36a50f

  - non-isolated-requirements.json

  # Needed by the setup script.
  - ../shared-modules/intltool/intltool-0.51.json

  # Dependency for gexiv2
  - name: exiv2
    buildsystem: cmake-ninja
    config-opts:
      # - -DEXIV2_ENABLE_BMFF=ON
      - -DEXIV2_ENABLE_INIH=OFF
    builddir: true
    sources:
      - type: archive
        url:  https://github.com/Exiv2/exiv2/archive/refs/tags/v0.28.1.tar.gz
        sha256: 3078651f995cb6313b1041f07f4dd1bf0e9e4d394d6e2adc6e92ad0b621291fa

  - name: gexiv2
    buildsystem: meson
    build-options:
      prepend-path: /usr/lib/sdk/vala/bin/
      prepend-ld-library-path: /usr/lib/sdk/vala/lib
      env:
        - -PKG_CONFIG_GOBJECT_INTROSPECTION_1_0_GIRDIR=/app/share/gir-1.0
        - -PKG_CONFIG_GOBJECT_INTROSPECTION_1_0_TYPELIBDIR=/app/lib/girepository-1.0
    sources:
      - type: archive
        url:  https://download.gnome.org/sources/gexiv2/0.14/gexiv2-0.14.2.tar.xz
        sha256: 2a0c9cf48fbe8b3435008866ffd40b8eddb0667d2212b42396fdf688e93ce0be

  # Optional runtime dependency
  - name: ImageMagick
    buildsystem: simple
    build-commands:
      - ./configure --prefix /app
      - make install
    sources:
      - type: archive
        url: https://github.com/ImageMagick/ImageMagick/archive/refs/tags/7.1.1-39.tar.gz
        sha256: b2eb652d9221bdeb65772503891d8bfcfc36b3b1a2c9bb35b9d247a08965fd5d

  # Build dependency for Feh
  - name: Imlib2
    buildsystem: simple
    build-commands:
      - ./configure --prefix /app
      - make install
    sources:
      - type: archive
        # I'm not sure if this is a stable URL.
        url: https://kumisystems.dl.sourceforge.net/project/enlightenment/imlib2-src/1.12.3/imlib2-1.12.3.tar.xz?viasf=1
        sha256: 96244656576a3e0a6f58b78e514ddc919622ac6806711bc231837eee62c1de34

  # Optional runtime dependency
  # Nitrogen is an alternative but needs GTK 2, which is harder to supply.
  - name: Feh
    buildsystem: simple
    build-commands:
      - cd man
      - PREFIX=/app make all
      - PREFIX=/app make install
    sources:
      - type: archive
        url: https://feh.finalrewind.org/feh-3.10.3.tar.bz2
        sha256: 5426e2799770217af1e01c2e8c182d9ca8687d84613321d8ab4a66fe4041e9c8

  # # Optional runtime dependency
  - ../shared-modules/libayatana-appindicator/libayatana-appindicator-gtk3.json

  # libavif-gdk-pixbuf is already included in the platform.

  # Need dconf to actually read/write settings on GNOME
  - name: DConf
    buildsystem: meson
    builddir: true
    config-opts:
      - -Dbash_completion=false
      - -Dvapi=false
    sources:
      - type: archive
        url: https://download.gnome.org/sources/dconf/0.40/dconf-0.40.0.tar.xz
        sha256: cf7f22a4c9200421d8d3325c5c1b8b93a36843650c9f95d6451e20f0bcb24533

  - name: Variety
    buildsystem: simple
    build-commands:
      # variety.py is apparently needed by the setup script.
      # - cp bin/variety bin/variety.py
      - python3 setup.py install --prefix /app
      # Remove variety.py again to avoid startup failure.
      - mv /app/share/metainfo/variety.appdata.xml /app/share/metainfo/io.github.varietywalls.variety.metainfo.xml
      - mv /app/share/applications/variety.desktop /app/share/applications/io.github.varietywalls.variety.desktop
      - mv /app/share/icons/hicolor/scalable/apps/variety.svg /app/share/icons/hicolor/scalable/apps/io.github.varietywalls.variety.svg
      - mv /app/share/icons/hicolor/22x22/apps/variety-indicator-dark.png /app/share/icons/hicolor/22x22/apps/io.github.varietywalls.variety-indicator-dark.png
      - mv /app/share/icons/hicolor/22x22/apps/variety-indicator.png /app/share/icons/hicolor/22x22/apps/io.github.varietywalls.variety-indicator.png
      - mv /app/share/variety/media/variety-indicator-num1.png /app/share/icons/hicolor/22x22/apps/io.github.varietywalls.variety-indicator-num1.png
      - mv /app/share/variety/media/variety-indicator-num2.png /app/share/icons/hicolor/22x22/apps/io.github.varietywalls.variety-indicator-num2.png
      - mv /app/share/variety/media/variety-indicator-num3.png /app/share/icons/hicolor/22x22/apps/io.github.varietywalls.variety-indicator-num3.png
      - mv /app/share/variety/media/variety-indicator-num4.png /app/share/icons/hicolor/22x22/apps/io.github.varietywalls.variety-indicator-num4.png

      # - rm /app/bin/variety.py
    sources:
      - type: dir
        path: ..
        skip:
          - flatpak-resources
          - flatpak-pip-generator
