# TODO: Should the app ID be com.peterlevi.Variety?
app-id: io.github.varietywalls.variety
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  # Dependency for gexiv2 and libayatana
  - org.freedesktop.Sdk.Extension.vala
command: variety
finish-args:
  - --device=dri
  - --share=network
  - --socket=fallback-x11
  - --socket=wayland
  - --own-name=com.peterlevi.Variety
  # Needed to display app indicator.
  - --talk-name=org.kde.StatusNotifierWatcher
  # Needed for notifications to work.
  - --talk-name=org.freedesktop.Notifications
  # TODO: Test if this is needed or if it should be a persisted directory.
  # - --filesystem=xdg-config/variety-profiles
  # Config is hardcoded to be in ~/.config/variety, so persist it.
  - --persist=.config/variety
  # The code also hardcodes ~/Pictures, but only as a fallback to xdg-pictures, which will always be defined in a Flatpak. Write access is needed for "Move to Favourites" functionality.
  - --filesystem=xdg-pictures
  # Read wallpapers from /usr/share/backgrounds.
  - --filesystem=host-os:ro
  # Register Variety to start on login
  - --filesystem=~/.config/autostart
  # Create a desktop file for different Variety profiles
  - --filesystem=~/.local/share/applications
  # Read the current LXQt wallpaper
  - --filesystem=xdg-config/pcmanfm-qt/lxqt/settings.conf:ro
  # Read the current KDE 5 wallpaper
  - --filesystem=xdg-config/plasma-org.kde.plasma.desktop-appletsrc:ro
  # Allow wallpaper to be read and written using gsettings
  - --filesystem=xdg-run/dconf
  - --filesystem=xdg-config/dconf:ro
  - --talk-name=ca.desrt.dconf
  - --env=DCONF_USER_CONFIG_DIR=.config/dconf
  - --env=GIO_EXTRA_MODULES=/app/lib/gio/modules/
cleanup:
# TODO: Figure out what's needed at runtime, remove everything else.
  - /bin/dbus-*
  - /bin/normalizer
  - /include
modules:
  - build-requirements.json
  - non-isolated-build-requirements.json
  - requirements.json

  # dbus-run-session is needed to build dbus-python
  # It's provided by org.gnome.Sdk//47
  - name: dbus
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DDBUS_BUILD_TESTS=OFF
      - -DENABLE_TRADITIONAL_ACTIVATION=OFF
      - -DENABLE_SYSTEMD=OFF
      - -DDBUS_BUS_ENABLE_INOTIFY=OFF
      - -DDBUS_ENABLE_DOXYGEN_DOCS=OFF
    sources:
      - type: archive
        url: https://dbus.freedesktop.org/releases/dbus/dbus-1.14.10.tar.xz
        sha256: ba1f21d2bd9d339da2d4aa8780c09df32fea87998b73da24f49ab9df1e36a50f
    cleanup:
      - /etc/dbus-1
      - /share/doc/dbus

  - non-isolated-requirements.json

  # Needed by the setup script.
  - ../shared-modules/intltool/intltool-0.51.json

  # Dependency for gexiv2
  - name: exiv2
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DEXIV2_ENABLE_INIH=OFF
    builddir: true
    sources:
      - type: archive
        url:  https://github.com/Exiv2/exiv2/archive/refs/tags/v0.28.1.tar.gz
        sha256: 3078651f995cb6313b1041f07f4dd1bf0e9e4d394d6e2adc6e92ad0b621291fa
    cleanup:
      - /bin/exiv2

  - name: gexiv2
    buildsystem: meson
    build-options:
      prepend-path: /usr/lib/sdk/vala/bin/
      prepend-ld-library-path: /usr/lib/sdk/vala/lib
      env:
        - -PKG_CONFIG_GOBJECT_INTROSPECTION_1_0_GIRDIR=/app/share/gir-1.0
        - -PKG_CONFIG_GOBJECT_INTROSPECTION_1_0_TYPELIBDIR=/app/lib/girepository-1.0
    sources:
      - type: archive
        url:  https://download.gnome.org/sources/gexiv2/0.14/gexiv2-0.14.2.tar.xz
        sha256: 2a0c9cf48fbe8b3435008866ffd40b8eddb0667d2212b42396fdf688e93ce0be
    cleanup:
      - /share/vala/vapi/gexiv2.*

  # Optional runtime dependency
  - name: ImageMagick
    buildsystem: simple
    build-commands:
      - ./configure --prefix /app
      - make install
    sources:
      - type: archive
        url: https://github.com/ImageMagick/ImageMagick/archive/refs/tags/7.1.1-39.tar.gz
        sha256: b2eb652d9221bdeb65772503891d8bfcfc36b3b1a2c9bb35b9d247a08965fd5d
    cleanup:
      - /bin/animate
      - /bin/compare
      - /bin/composite
      - /bin/conjure
      - /bin/display
      - /bin/import
      - /bin/magick-script
      - /bin/Magick*
      - /bin/mogrify
      - /bin/montage
      - /bin/stream
      - /share/doc/ImageMagick-7

  # Build dependency for Feh
  - name: Imlib2
    buildsystem: simple
    build-commands:
      - ./configure --prefix /app
      - make install
    sources:
      - type: archive
        # I'm not sure if this is a stable URL.
        url: https://kumisystems.dl.sourceforge.net/project/enlightenment/imlib2-src/1.12.3/imlib2-1.12.3.tar.xz?viasf=1
        sha256: 96244656576a3e0a6f58b78e514ddc919622ac6806711bc231837eee62c1de34
    cleanup:
      - /bin/imlib2_*

  # Optional runtime dependency
  # Nitrogen is an alternative but needs GTK 2, which is harder to supply.
  - name: Feh
    buildsystem: simple
    build-commands:
      - cd man
      - PREFIX=/app make all
      - PREFIX=/app make install
    sources:
      - type: archive
        url: https://feh.finalrewind.org/feh-3.10.3.tar.bz2
        sha256: 5426e2799770217af1e01c2e8c182d9ca8687d84613321d8ab4a66fe4041e9c8
    cleanup:
      - /share/doc/feh

  # Optional runtime dependency
  - ../shared-modules/libayatana-appindicator/libayatana-appindicator-gtk3.json

  # libavif-gdk-pixbuf is already included in the platform.

  # Optional runtime dependency
  - name: fortune-mod
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DNO_OFFENSIVE=TRUE
    post-install:
      - mv /app/games/fortune ../bin/fortune
    sources:
      - type: archive
        url: https://github.com/shlomif/fortune-mod/releases/download/fortune-mod-3.22.0/fortune-mod-3.22.0.tar.xz
        sha256: 069321bb4d4ae3abf55493d043cea06534dc93f1a2c29e86694d9edb1380a0e3
      - type: patch
        path: patches/fortune-mod-no-man.patch
    sources:
      - /bin/rot
      - /bin/strfile
      - /bin/unstr

  # Need dconf to actually read/write settings on GNOME
  - name: DConf
    buildsystem: meson
    builddir: true
    config-opts:
      - -Dbash_completion=false
      - -Dvapi=false
    sources:
      - type: archive
        url: https://download.gnome.org/sources/dconf/0.40/dconf-0.40.0.tar.xz
        sha256: cf7f22a4c9200421d8d3325c5c1b8b93a36843650c9f95d6451e20f0bcb24533
    cleanup:
      - /libexec/dconf-service

  - name: Variety
    buildsystem: simple
    build-commands:
      - sed -i 's|<id>variety.desktop</id>|<id>io.github.varietywalls.variety</id>|' variety.appdata.xml
      - sed -i 's|<launchable type="desktop-id">variety.desktop</launchable>|<launchable type="desktop-id">io.github.varietywalls.variety.desktop</launchable>|' variety.appdata.xml
      - sed -i 's|Icon=variety|Icon=io.github.varietywalls.variety|' variety.desktop.in
      - sed -i 's|APP_ID = "variety"|APP_ID = "io.github.varietywalls.variety"|' variety/indicator.py

      - python3 setup.py install --prefix /app

      - mv /app/share/metainfo/variety.appdata.xml /app/share/metainfo/io.github.varietywalls.variety.metainfo.xml
      - mv /app/share/applications/variety.desktop /app/share/applications/io.github.varietywalls.variety.desktop

      - mv /app/share/icons/hicolor/scalable/apps/variety.svg /app/share/icons/hicolor/scalable/apps/io.github.varietywalls.variety.svg
      - mv /app/share/icons/hicolor/22x22/apps/variety-indicator-dark.png /app/share/icons/hicolor/22x22/apps/io.github.varietywalls.variety-indicator-dark.png
      - mv /app/share/icons/hicolor/22x22/apps/variety-indicator.png /app/share/icons/hicolor/22x22/apps/io.github.varietywalls.variety-indicator.png

      - mv /app/share/variety/media/variety-indicator.svg /app/share/icons/hicolor/scalable/apps/io.github.varietywalls.variety-indicator.svg
      - mv /app/share/variety/media/variety-indicator-dark.svg /app/share/icons/hicolor/scalable/apps/io.github.varietywalls.variety-indicator-dark.svg
      - mv /app/share/variety/media/variety-indicator-num1.png /app/share/icons/hicolor/22x22/apps/io.github.varietywalls.variety-indicator-num1.png
      - mv /app/share/variety/media/variety-indicator-num1.svg /app/share/icons/hicolor/scalable/apps/io.github.varietywalls.variety-indicator-num1.svg
      - mv /app/share/variety/media/variety-indicator-num2.png /app/share/icons/hicolor/22x22/apps/io.github.varietywalls.variety-indicator-num2.png
      - mv /app/share/variety/media/variety-indicator-num2.svg /app/share/icons/hicolor/scalable/apps/io.github.varietywalls.variety-indicator-num2.svg
      - mv /app/share/variety/media/variety-indicator-num3.png /app/share/icons/hicolor/22x22/apps/io.github.varietywalls.variety-indicator-num3.png
      - mv /app/share/variety/media/variety-indicator-num3.svg /app/share/icons/hicolor/scalable/apps/io.github.varietywalls.variety-indicator-num3.svg
      - mv /app/share/variety/media/variety-indicator-num4.png /app/share/icons/hicolor/22x22/apps/io.github.varietywalls.variety-indicator-num4.png
      - mv /app/share/variety/media/variety-indicator-num4.svg /app/share/icons/hicolor/scalable/apps/io.github.varietywalls.variety-indicator-num4.svg
    sources:
      - type: dir
        path: ..
        skip:
          - flatpak-resources
          - flatpak-pip-generator
